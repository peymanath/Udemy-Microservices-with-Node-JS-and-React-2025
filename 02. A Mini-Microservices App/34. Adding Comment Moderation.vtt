WEBVTT

00:00.850 --> 00:03.780
الان یه ساختار اولیه برای سرویس مدیریت نظارت پیاده‌سازی کردیم.

00:03.790 --> 00:07.900
حالا باید بریم سراغ هر سه تا سرویس‌مون و چند تا تغییر کوچیک توشون ایجاد کنیم.

00:07.900 --> 00:08.740
هر کدومشون یه مقدار نیاز به تغییر دارن.

00:08.950 --> 00:13.870
تو بعضی از موارد، لازمه یه ایونت موجود رو تغییر بدیم، و تو بعضی موارد هم باید یه ایونت جدید اضافه کنیم.

00:15.100 --> 00:19.810
می‌خوایم قدم به قدم بریم جلو و جریان کامل ارسال یه کامنت توسط کاربر رو دنبال کنیم.

00:19.810 --> 00:20.590
ببینیم دقیقا چی اتفاق می‌افته.

00:20.800 --> 00:23.230
وقتی کاربر یه کامنت ارسال می‌کنه، چی می‌شه؟

00:23.260 --> 00:27.640
یادت باشه که در حال حاضر، ما فقط اون کامنت رو توی سرویس comment ذخیره می‌کنیم.

00:28.000 --> 00:31.420
فعلاً فقط آیدی و متن کامنت رو ذخیره می‌کنیم.

00:31.810 --> 00:37.840
اما احتمالاً بهتره که وضعیت اون کامنت رو هم ذخیره کنیم. مثل اینکه هنوز در حال بررسیه، تأیید شده یا رد شده.

00:39.070 --> 00:43.720
پس وقتی کاربر کامنت رو ثبت می‌کنه، علاوه بر اطلاعات قبلی، باید وضعیتش رو هم به عنوان "در انتظار بررسی" ذخیره کنیم.

00:48.910 --> 00:50.880
بریم سراغ ادیتورمون و کد رو باز کنیم.

00:50.890 --> 00:53.980
می‌ریم سراغ سرویس کامنت و اون تغییر رو همین الان انجام می‌دیم.

00:54.780 --> 00:56.310
پس برگشتم به ادیتورم.

00:56.880 --> 00:58.530
سرویس comment رو پیدا می‌کنم.

00:58.950 --> 01:01.110
وارد فایل index می‌شم.

01:03.080 --> 01:07.340
حالا می‌رم پایین‌تر جایی که یه کامنت جدید توی هندلر POST ساخته می‌شه.

01:08.170 --> 01:11.530
یه مرور سریع روی کد می‌کنیم که ببینیم چی داره اتفاق می‌افته.

01:11.860 --> 01:15.220
یه آیدی رندوم تولید می‌کنیم، متن کامنت رو می‌گیریم.

01:16.140 --> 01:21.180
لیست کامنت‌هایی که به اون پست مرتبط هستن رو از دیتا می‌گیریم.

01:21.810 --> 01:25.400
و دقیقاً اینجا جاییه که کامنت جدید رو می‌سازیم.

01:25.410 --> 01:27.570
اون شیء، همون کامنته.

01:28.050 --> 01:33.360
حالا باید یه پراپرتی جدید به اون شیء اضافه کنیم به اسم status که پیش‌فرضش "pending" باشه.

01:34.160 --> 01:40.010
پس داخل اون شیء، یه پراپرتی جدید به اسم status با مقدار pending اضافه می‌کنیم.

01:41.190 --> 01:42.000
این بهتره.

01:44.000 --> 01:45.320
با مقدار pending به این شکل.

01:46.570 --> 01:46.930
اوکیه.

01:46.930 --> 01:47.920
این شد مرحله اول.

01:48.250 --> 01:50.980
حالا برگردیم به دیاگراممون ببینیم مرحله بعد چیه.

01:51.720 --> 01:57.360
مرحله دوم اینه که، هر وقت یه کامنت جدید ساختیم، بلافاصله باید یه ایونت ارسال کنیم.

01:57.360 --> 01:58.980
اون ایونت، comment created هست.

01:59.490 --> 02:02.280
این ایونت می‌ره داخل event bus و فرستاده می‌شه به:

02:03.230 --> 02:08.630
سرویس moderation و همچنین سرویس query.

02:12.180 --> 02:16.740
یادت باشه ما این ایونت رو برای سرویس query می‌فرستیم تا اون بتونه فوراً اون کامنت رو ذخیره کنه.

02:16.740 --> 02:18.210
هدف اینه که سریعا ذخیره بشه.

02:18.600 --> 02:23.100
کل ایده‌ این بود که مطمئن بشیم query service بلافاصله بعد از ارسال، یه نسخه از اون کامنت داشته باشه.

02:23.100 --> 02:28.440
که اگه کاربر صفحه رو رفرش کرد، بلافاصله اون کامنت رو ببینه، نه اینکه منتظر بمونه تا ایونت تأیید یا رد از سرویس moderation بیاد.

02:34.420 --> 02:39.760
پس الان باید بریم سرویس query و مطمئن بشیم که وقتی اون ایونت ارسال می‌شه، پراپرتی status رو هم ازش می‌گیریم و ذخیره می‌کنیم.

02:40.600 --> 02:45.550
همچنین باید مطمئن بشیم که خود ایونت شامل status هم هست.

02:52.750 --> 02:54.850
اول بریم سراغ سرویس comment.

02:55.450 --> 02:57.460
اینجا جاییه که همین الان هم نگاهش کردیم.

02:57.730 --> 03:00.250
اینجا ایونت comment created ساخته می‌شه.

03:00.430 --> 03:03.360
الان هنوز status توش نیومده.

03:03.370 --> 03:08.920
پس الان داخل پراپرتی data، status: "pending" رو اضافه می‌کنیم.

03:09.980 --> 03:15.200
حالا وقتی این ایونت می‌ره سمت سرویس query، اون متوجه می‌شه که یه کامنت ساخته شده با status برابر با pending.

03:19.300 --> 03:21.280
حالا بریم سرویس query رو باز کنیم.

03:21.280 --> 03:24.040
می‌خوایم مطمئن بشیم که وقتی ایونت رو دریافت کرد، این اطلاعات جدید رو ذخیره می‌کنه.

03:24.040 --> 03:28.060
یعنی همون status: "pending" که الان بهش اضافه کردیم.

03:29.320 --> 03:31.300
پس الان می‌رم به سمت سرویس query.

03:31.330 --> 03:33.400
اینجاست فایل index ش.

03:34.380 --> 03:38.190
می‌رم پایین‌تر توی کدی که مربوط به هندل کردن ایونت comment created هست.

03:40.040 --> 03:43.640
حالا پراپرتی status رو هم از data می‌گیریم.

03:45.030 --> 03:49.570
و موقع اضافه کردن کامنت به آرایه‌ی کامنت‌ها، این پراپرتی status رو هم ذخیره می‌کنیم.

03:49.570 --> 03:50.820
مثل این:

03:50.830 --> 03:51.490
status: status

03:53.960 --> 03:54.280
اوکیه.

03:54.360 --> 03:55.130
درست شد.

03:56.360 --> 03:56.720
خیلی خب.

03:56.720 --> 03:58.670
تا اینجای کار رو انجام دادیم.

03:58.700 --> 04:03.110
حالا قدم بعدی اینه که مطمئن بشیم فرآیند ساخت کامنت رو توی سرویس moderation هم مدیریت می‌کنیم.

04:04.550 --> 04:09.500
یادت باشه کل هدف اینه که محتویات پراپرتی content داخل اون ایونت رو بررسی کنیم

04:09.500 --> 04:11.900
و ببینیم آیا کلمه "orange" توش هست یا نه.

04:12.170 --> 04:17.810
اگه کلمه "orange" توش بود، یه ایونت comment moderated با status برابر با "rejected" ارسال می‌کنیم.

04:17.810 --> 04:21.230
در غیر این صورت، ایونت comment moderated با status برابر با "approved" می‌فرستیم.

04:21.710 --> 04:25.370
بذار یه مکث کوتاه داشته باشیم اینجا، بعدش ادامه می‌دیم و می‌ریم سراغ پیاده‌سازی توی سرویس moderation.
